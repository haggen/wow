#!/usr/bin/env bash

#
# Release new version of given add-on.
#

set -euo pipefail

help() {
	cat <<-EOF >&2
		Usage: $0 [-h|-p|-m|-M] <path>
	EOF
}

opts=$(getopt -n "$0" -o hpmM -l help,patch,minor,major -- "$@")

if test $? -ne 0; then
	exit 1
fi

eval set -- "$opts"

while :; do
	case "$1" in
		-p|--patch)
			bump="patch"
			shift
			;;
		-m|--minor)
			bump="minor"
			shift
			;;
		-M|--major)
			bump="major"
			shift
			;;
		-h|--help)
			help
			exit
			;;
		--)
			shift
			break
			;;
	esac
done

if test -z "$*"; then
	echo "$0: missing argument, try --help for more information" >&2
	exit 1
fi

target="$1"

if ! test -d "$target"; then
	echo "$0: '$target' is not a directory" >&2
	exit 1
fi

if ! scripts/lint "$target"; then
	echo "$0: linting failed" >&2
	exit 1
fi

release="$(scripts/inspect "$target")"
tag="$(scripts/inspect -t "$target")"

scripts/bump "--$bump" "$target"

git tag -m "Release $release" "$tag"
git push --follow-tags
