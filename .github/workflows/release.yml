name: Release tagged add-on

on:
  push:
    tags:
      - "*/*"

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: sudo apt-get --no-install-recommends install libxml2-utils lua-check
      - name: Prepare environment
        run: scripts/env "$GITHUB_REF" >> "$GITHUB_ENV"
      - name: Lint source files
        run: scripts/lint "$ADDON"
      - name: Generate archive
        run: scripts/archive "$TAG"
      - name: Generate changelog
        run: scripts/changelog "$TAG"
      - name: Upload to GitHub
        uses: softprops/action-gh-release@v1
        with:
          body_path: dist/CHANGELOG.md
          files: dist/*.zip
          tag_name: ${{ env.TAG }}
          draft: false
          name: ${{ env.RELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload to CurseForge
        env:
          CURSEFORGE_TOKEN: ${{ secrets.CURSEFORGE_TOKEN }}
        run: scripts/upload -t "$CURSEFORGE_TOKEN" "$TAG"
